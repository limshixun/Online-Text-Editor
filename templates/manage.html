<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static', filename='manage.css') }}">
    <title>Documents</title>
</head>
<body>
    <h1>{{username}}'s Document List</h1>
    <br>
    <form class="container" id="manageDoc" method="post" action="/">
        <div class="menu">
            <button type="button" onclick="openPopup('cre')">Create new file    +</button>
            <button class="btn-disabled warning" type="button" id="delBtn" onclick="openPopup('del')" disabled>Delete selected files    -</button>
            <input class="warning" type="submit" name="logout" id="logout" value="Log out">
        </div>
        <table class="table-container" id="doc-table">
            <thead>
                <tr>
                    <th> </th>
                    <th class="flex">
                        <label>Title</label>
                        <button type="button" id="title" class="box sort" onclick="sortTable(1)"><img src="../static/icon/up-down.png"></button>
                    </th>
                    <th class="flex" >
                        <label>Date Modified</label>
                        <button type="button" id="date" class="box sort" onclick="sortTable(2)"><img src="../static/icon/up-down.png" ></button>
                    </th>
                    <th class="flex">
                        <label>Size (KB)</label>
                        <button type="button" id="size" class="box sort" onclick="sortTable(3)"><img src="../static/icon/up-down.png"></button>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for doc in documents %}
                    <tr>
                        <td><input type="checkbox" name="{{doc[0]}}" id="{{doc[0]}}" value="{{doc[0]}}"></td>
                        <td><a class="file-link" name="{{ doc[1] }}" href="{{ url_for('text_editor', doc_id=doc[0]) }}" >{{ doc[1] }}</a></td>
                        <td>{{doc[3]}}</td>
                        <td>{{doc[4]}}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>

    <div class="popup-container" id="cre-popup">
        <form class="popup-form" method="post" action="/">
            <h2>Create New Document</h2>
            <label>Document name</label><br>
            <input type="text" name="DocName" id="DocName" required>
            <div>
                <input type="submit" name="createDoc" id="createDoc" value="Create">
                <button type="button" onclick="closePopup('cre')">Cancel</button>
            </div>
        </form>
    </div>

    <div class="popup-container" id="del-popup">
        <form class="popup-form" method="post" action="/">
            <h2>The selected documents will be delete PERMANENTLY</h2>
            <!--This hidden input is used to send doc_ids of each checkbox to the flask-->
            <!--When we track which checkbox is checked using eventhandler-->
            <!--Submit all the doc_id that is append to this input's value when this form is submitted-->
            <input type="hidden" name="doc_ids" id="doc_ids" value="">
            <div>
                <input type="submit" name="ConfirmDel" id="ConfirmDel" value="Yes" required>
                <button type="button" onclick="closePopup('del')">Cancel</button>
            </div>
        </form>
    </div>

    <script>
        let crePopup = document.getElementById("cre-popup")
        let delPopup = document.getElementById("del-popup")
        let checkboxes = document.querySelectorAll('input[type="checkbox"]');
        let doc_ids = document.getElementById("doc_ids")
        let sortButtons = document.querySelectorAll('button[class="box sort"]') 
        let manageForm = document.getElementById("manageDoc")

        // Open the popup by adding the class that has css style of hidden to the entire div
        function openPopup(type){
            if (type == 'cre'){
                crePopup.classList.add("open-popup")

            }else if(type == 'del'){
                // When we are opening the popup for deleting documents
                // We also pass the doc_ids for all the checked checkbox to the hidden input so that it can be passed to the flask
                doc_ids.value = getSelectedDocs(checkboxes)
    
                delPopup.classList.add("open-popup")
            }
        }
        // Close the popup by removing the class from classlist which has css style of hidden
        function closePopup(type){
            if (type == 'cre'){
                crePopup.classList.remove("open-popup")
            }else if(type == 'del'){
                delPopup.classList.remove("open-popup")
            }
        }

        // Return all the checked checkboxes' doc_id
        function getSelectedDocs(checkboxes) {
            let selectedDocs = [];
            checkboxes.forEach((checkbox) => {
                if (checkbox.checked) {
                    selectedDocs.push(checkbox.value);
                }
            });

            return selectedDocs;
        }

        // If there is any checkbox is checked, return true, to enable del button
        function isCheck(checkboxes) {
        for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                return true;
            }
        }
        return false;
        }

        // Function to enable/disable del button if any checkbox is checked
        function enableDelBtn() {
            const delBtn = document.getElementById("delBtn");

            // Enable del btn if any checkbox is checked, vice versa
            if (isCheck(checkboxes)) {
                // Enable delete button when at least one checkbox is checked
                delBtn.disabled = false; 
                // remove the style for disabled button
                delBtn.classList.remove("btn-disabled")
            } else {
                // disable the button when None of the checkbox is checked
                delBtn.disabled = true; 
                // add the style for disabled button
                delBtn.classList.add("btn-disabled")

            }
        }

        // Add an event listener to checkboxes to update the delete button state
        // When the checkbox is any checkbox is checked only then will the delete button is enabled
        checkboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", enableDelBtn);
        });

        
        // Change the sort button icon based on different type
        function setSortImage(button,type){
            let imgElem = button.querySelector('img')
            if (type == "neutral"){
                imgElem.src = "../static/icon/up-down.png"
            }else if (type == "descending"){
                imgElem.src = "../static/icon/down-arrow.png"
            }else if (type == "ascending"){
                imgElem.src = "../static/icon/up-arrow.png"
            }else{
                throw Error("wrong button or type in setSortImage")
            }
        }

        // Reset all the sort button icon back to neutral
        function resetSort(){
            sortButtons.forEach((button) => {
                setSortImage(button,"neutral")
            })
        }

        function changeDiagram(button){
            let imgElem = button.querySelector('img')
            // Get the current icon src
            let src = imgElem.src;
            // Reset after getting the previous icon src so i will not disturb the change
            resetSort()
            // neutral --> desc --> asc --> desc --> asc ......
            if (src.includes("up-down.png")) {
                setSortImage(button, "descending");
            } else if (src.includes("down-arrow.png")) {
                setSortImage(button, "ascending");
            } else if (src.includes("up-arrow.png")) {
                setSortImage(button, "descending");
            } else {
                throw Error("Error in changeDiagram()");
            }
        }

        sortButtons.forEach((button) => {
            button.addEventListener("click", () => {
                changeDiagram(button)
            });
        })
        
        let ascending = NaN

        // Switch order of sorting
        function changeAscending(){
            if(ascending ==NaN){
                // The First order after neutral is Ascending
                ascending = true
            }else{
                ascending = !ascending
            }
        }

        // idea from https://www.w3schools.com/howto/howto_js_sort_table.asp
        function sortTable(colNum){
            let table = document.getElementById("doc-table")
            let sorting = true
            let switchcount = 0
            let shouldSwitch, rows, currentRowData, nextRowData
            changeAscending()
            while (sorting) {
                sorting = false
                // return an arr of tr (table row) element
                rows = table.rows
                // Excluding header row where i==0, we compare the value of table data in specific column (colNum)
                // In this for loop, we only check if row i will switch with i+1
                // If we need to switch row i and i + 1, we will first break the for loop then switch the row.
                // If none of the row need swtiching, end the sorting
                for ( i = 1; i < (rows.length - 1); i++) {
                    // Get the table data of current row and next row
                    currentRowData = rows[i].getElementsByTagName("td")[colNum];
                    nextRowData = rows[i+1].getElementsByTagName("td")[colNum];

                    // Default as should not switch 
                    shouldSwitch = false;

                    // Since the innerHtml of the first column is an achor, we will further dig into the innerHTML of the anchor to get the text 
                    if(colNum == 1){
                        // set the anchor element as the current element
                        currentRowData = currentRowData.querySelector('.file-link')
                        nextRowData = nextRowData.querySelector('.file-link')
                    }

                    //check if the two rows should switch place
                    if (ascending) {
                        // In ascending orderIf current data is greater than next data
                        shouldSwitch = (currentRowData.innerHTML.toLowerCase()) > (nextRowData.innerHTML.toLowerCase())
                    }else{
                        // If current data is lesser than next data
                        shouldSwitch = (currentRowData.innerHTML.toLowerCase()) < (nextRowData.innerHTML.toLowerCase())
                    }
                    // If any of the row needed to be switch, break the loop so that we can switch them
                    if(shouldSwitch){
                        break;
                    }
                }
                if(shouldSwitch){
                    // In this line, we first access the parent of tr which is tbody
                    // then switch the row with insertBefore method
                    rows[i].parentNode.insertBefore(rows[i+1], rows[i]);
                    sorting = true
                }
            }
        }
    </script>
</body>
</html>